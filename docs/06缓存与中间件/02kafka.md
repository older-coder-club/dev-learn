# Kafka 专题面试指南（提炼版）

说明：本文件迁移《缓存与中间件详解》中 Kafka 相关全部内容，结构化便于面试复盘。

---

## 1. Kafka 基础与可靠性

（摘自原文 6.x）

### 1.1 Partition 分区与并行度 [5]
- 是什么：Topic 由多个分区组成，分区内部顺序保证。  
- 为什么：水平扩展吞吐与消费并发。  
- 怎么用：分区键（hash）控制数据倾斜；热点拆分。  
- 关键细节：分区数过多增加元数据与管理成本；顺序仅同分区有效。  
- 面试提示：说明“分区数与吞吐提升并非线性”。

### 1.2 副本与 ISR [5]
- 是什么：Leader + follower 构成副本；ISR（同步副本集合）用于确定 ack=all 持久性。  
- 为什么：保证容错与数据可靠。  
- 怎么用：min.insync.replicas 配合 acks=all；监控 ISR 缩减。  
- 关键细节：unclean leader election 可能丢数据；禁止开启除特殊场景。  
- 面试提示：描述一次 Leader 崩溃后的恢复过程。

### 1.3 日志段与保留策略 [4]
- 是什么：message log 分段存储；按大小/时间滚动；可启用压缩（compaction）。  
- 为什么：高效顺序写与归档。  
- 怎么用：retention.ms / retention.bytes / cleanup.policy=compact。  
- 关键细节：压缩基于 key 保留最新值；大消息影响页缓存。  
- 面试提示：解释“为什么小消息过多降低吞吐”。

### 1.4 消费位移管理 [5]
- 是什么：__consumer_offsets 内部主题记录消费进度。  
- 为什么：容错重启可恢复位置。  
- 怎么用：enable.auto.commit 或手动 commitSync/Async；批量处理后提交。  
- 关键细节：过早提交导致丢消息；过晚提交增加重复消费窗口。  
- 面试提示：给出“手动提交 + 幂等”组合策略。

### 1.5 Rebalance 机制与影响 [4]
- 是什么：成员加入/离开/订阅变更触发重新分配分区。  
- 为什么：保持负载均衡与故障恢复。  
- 怎么用：CooperativeSticky 降低暂停时长；优化分区映射。  
- 关键细节：过多 Rebalance 导致消费长时间停顿；会话超时设置。  
- 面试提示：分析“频繁 Rebalance”的根因（心跳/处理慢）。

### 1.6 ACK 语义与持久性 [4]
- 是什么：acks=0/1/all 控制确认策略；与 min.insync.replicas 组合实现高可靠。  
- 为什么：在延迟与可靠之间平衡。  
- 怎么用：金融/订单场景使用 acks=all + 合理 ISR。  
- 关键细节：acks=1 下 Leader 未落盘可能丢消息；幂等生产进一步降低重复。  
- 面试提示：对比 acks=all 与幂等区别。

### 1.7 幂等生产与事务 [5]
- 是什么：enable.idempotence 保证单分区去重；事务扩展跨分区 + 消费原子写入。  
- 为什么：构建 Exactly-Once 处理链。  
- 怎么用：事务：initTransactions -> beginTransaction -> send -> commitTransaction。  
- 关键细节：事务要求使用同一个 producer，超时与错误需 abort；幂等不解决跨分区原子性。  
- 面试提示：完整说出 Exactly-Once 必要条件组合。

### 1.8 Lag 与背压控制 [4]
- 是什么：Lag=生产位移 - 消费位移；衡量消费滞后。  
- 为什么：监控处理能力与拥塞。  
- 怎么用：基于 Lag 自动扩容消费者或报警；max.poll.interval.ms 改善批处理。  
- 关键细节：大量长处理阻塞心跳；避免一次拉取过多未处理。  
- 面试提示：Lag 持续增长排查路径（消费耗时 → 反序列化 → 分区不均）。

---

## 2. Kafka 性能调优

（摘自原文 7.x）

### 2.1 生产端批量参数 [4]
- 是什么：batch.size/linger.ms 控制批聚合；压缩算法 snappy/lz4/zstd。  
- 为什么：提高吞吐并降低网络与磁盘开销。  
- 怎么用：延迟容忍下增加 linger.ms 几毫秒聚合；适度 batch.size。  
- 关键细节：过大 linger 增加延迟；压缩适合大量可压缩文本；小消息压缩收益有限。  
- 面试提示：列出“吞吐 vs 延迟”调参取舍。

### 2.2 消费端拉取与并发 [4]
- 是什么：fetch.min.bytes/fetch.max.wait.ms 控制批量与等待；并发处理策略。  
- 为什么：把握吞吐 vs 响应时间。  
- 怎么用：高吞吐增大 fetch.min.bytes；多线程处理需保证顺序或使用分区线程池。  
- 关键细节：多线程共享 consumer 不安全；建议一个线程一个 consumer 或分发任务。  
- 面试提示：说明“为什么不建议多个线程直接操作同一个 consumer”。

### 2.3 零拷贝与 Page Cache 利用 [3]
- 是什么：sendfile 调用直接从文件描述符传输至 socket；减少用户态拷贝。  
- 为什么：提升吞吐与减少 CPU。  
- 怎么用：保持顺序写；避免过多随机访问。  
- 关键细节：Page Cache 命中率下降 → 磁盘 IO 提升；监控 OS 层指标。  
- 面试提示：解释“Kafka 不依赖内存数据库仍高性能”的原因。

---

## 3. 消息语义与投递模式

（摘自原文 8.x）

### 3.1 At-least-once 与幂等 [5]
- 是什么：至少一次可能重复；幂等保证业务结果一致。  
- 为什么：达到实用可靠：容忍重试。  
- 怎么用：幂等键、数据库唯一约束、状态检查。  
- 关键细节：重复窗口由提交策略与重试策略决定；重复非顺序的风险。  
- 面试提示：给出支付或库存幂等设计细节。

### 3.2 Exactly-once 处理链 [4]
- 是什么：Kafka 事务 + 幂等生产 + 消费端事务写入保证输入输出原子。  
- 为什么：避免重复与丢失组合影响。  
- 怎么用：事务消费者将偏移与结果写入一同 commit。  
- 关键细节：性能开销；跨系统（DB+Kafka）仍需外部机制。  
- 面试提示：指出“不是万能”适用范围限制。

### 3.3 延迟消息实现 [3]
- 是什么：Kafka 无原生定时精确投递；通过延迟主题或调度轮。  
- 为什么：实现定时任务/延迟重试。  
- 怎么用：分层重试 Topic；应用调度扫描到期消息。  
- 关键细节：大量延迟消息占压存储；轮询精度与性能权衡。  
- 面试提示：对比具备定时特性的消息系统（如 RocketMQ）。

---

## 4. 安全与访问控制（Kafka）

（摘自原文 12.2）

### 4.1 Kafka ACL 与认证 [3]
- 是什么：SASL/SCRAM / Kerberos + ACL 对 Topic/Group 控制。  
- 为什么：防止越权生产与消费。  
- 怎么用：集中管理脚本；定期审计 topic 权限。  
- 关键细节：明文配置安全风险；动态添加需滚动刷新。  
- 面试提示：描述最小权限实践。

---

## 5. 监控与故障排查（Kafka）

（摘自原文 13.2 / 14.2）

### 5.1 Kafka 关键指标 [4]
- 是什么：生产延迟、请求失败率、Lag、ISR 变化、字节入出、磁盘利用。  
- 为什么：保障吞吐与可靠性。  
- 怎么用：Lag 告警结合重试策略；ISR 缩减触发风险预警。  
- 关键细节：硬件瓶颈（磁盘、网络）；小消息过多。  
- 面试提示：排序排查：延迟→Lag→分区→消费速率。

### 5.2 Kafka Rebalance 频繁 [4]
- 是什么：消费组频繁触发分区重新分配。  
- 为什么：心跳超时/处理慢/成员波动。  
- 怎么用：提高 session.timeout.ms；优化消费处理逻辑；稳定部署。  
- 关键细节：Cooperative 模式减轻一次性暂停；偏移提交异常引发踢出。  
- 面试提示：列出至少三种根因与对应措施。

---

## 6. 序列化与压缩（Kafka 相关）

（摘自原文 15.1 / 15.2）

### 6.1 JSON vs 二进制协议 [3]
- 是什么：JSON 可读性高；二进制 (Protobuf/Kryo) 更紧凑与高速。  
- 为什么：网络与 CPU 成本权衡。  
- 怎么用：热路径使用 Protobuf；外围管理使用 JSON。  
- 关键细节：Schema 演进兼容性；对象池减少创建。  
- 面试提示：说明“为什么大批量消息换用二进制后 TPS 提升”。

### 6.2 压缩策略 [3]
- 是什么：Snappy/LZ4/Zstd 在 Kafka 等中间件使用；降低带宽。  
- 为什么：批量与文本消息压缩收益显著。  
- 怎么用：配置 compression.type；评估 CPU 与延迟。  
- 关键细节：小消息集合压缩比高；高 CPU 场景慎用重压缩。  
- 面试提示：描述“压缩适用与不适用场景”。

---

## 7. 面试问答速览（Kafka 相关）

（摘自原文 17.x）

1. Kafka Exactly-once 如何实现？幂等生产 + 事务 + 消费端原子位移提交。  
2. 分区数与吞吐关系？分区提升并行但非线性，受磁盘/网络/管理成本约束。  
3. Lag 排查路径？消费耗时 → 反序列化 → 分区不均 → 网络/磁盘瓶颈。  

---

## 8. 重要度汇总（Kafka）

（摘自原文 19.x 的相关条目）

- 分区/副本/位移 / 消息语义：[5]  
- 性能调优 / Rebalance / ACK：[4]
