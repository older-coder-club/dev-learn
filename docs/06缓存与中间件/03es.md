# Elasticsearch 专题面试指南（提炼版）

说明：本文件迁移《缓存与中间件详解》中 Elasticsearch 相关全部内容，聚焦核心原理与调优。

---

## 1. Elasticsearch 核心原理

（摘自原文 9.x）

### 1.1 倒排索引与分词 [4]
- 是什么：词项 -> 文档 ID 列表；分词器将文本切分、归一化。  
- 为什么：高效关键字检索。  
- 怎么用：合理选择 analyzer（standard/ik/custom）；区分 keyword vs text。  
- 关键细节：错误分词配置导致搜索不命中；停用词与大小写处理。  
- 面试提示：讲“keyword 与 text 使用场景差异”。

### 1.2 Doc Values 与聚合 [3]
- 是什么：列式存储，用于排序/聚合。  
- 为什么：避免加载全部源文档。  
- 怎么用：为需要排序/聚合字段启用 doc_values（默认）。  
- 关键细节：大量高基数聚合耗内存；限制结果大小。  
- 面试提示：说明聚合慢的根因与优化（分桶设计/预聚合）。

### 1.3 Segment 刷新与合并 [3]
- 是什么：写入先入内存缓冲，refresh 生成新 segment，可搜索；后台 merge 合并小 segment。  
- 为什么：平衡实时性与写入性能。  
- 怎么用：调整 refresh_interval；批量写入减少频繁刷新。  
- 关键细节：过低 refresh 影响写吞吐；合并过程高 IO。  
- 面试提示：区分“近实时”与“实时”。

### 1.4 深分页与 search_after [3]
- 是什么：from+size 深分页性能差；search_after 利用上一页排序值游标。  
- 为什么：避免扫描与丢弃大量结果。  
- 怎么用：使用 search_after 或 Scroll/PIT；限制最大分页深度。  
- 关键细节：排序字段必须唯一稳定；Scroll 不适合实时变化数据长时间持有。  
- 面试提示：给出“深分页慢”的替代方案。

---

## 2. 安全与访问控制（Elasticsearch）

（摘自原文 12.3）

### 2.1 Elasticsearch 安全 [3]
- 是什么：X-Pack/OpenSearch 提供角色、索引级权限与 TLS。  
- 为什么：保护敏感搜索与聚合数据。  
- 怎么用：角色映射；字段级屏蔽；审计日志。  
- 关键细节：默认无权限控制风险；内部节点通信需加密。  
- 面试提示：解释“为什么不能对外暴露未加固 ES”。

---

## 3. 监控与故障排查（Elasticsearch）

（摘自原文 13.3 / 14.3）

### 3.1 Elasticsearch 指标 [3]
- 是什么：查询耗时分位、段合并队列、GC、磁盘水位、线程池拒绝。  
- 为什么：定位搜索慢与集群风险。  
- 怎么用：监控 pending tasks；水位策略调度。  
- 关键细节：合并与刷新影响写入；高基数聚合内存爆炸。  
- 面试提示：从“查询慢”到“聚合高基数字段无优化”链路说明。

### 3.2 ES 集群黄/红状态 [3]
- 是什么：黄表示副本未分配；红表示主分片丢失不可用。  
- 为什么：节点故障/磁盘水位/分片过多。  
- 怎么用：查看 allocation explain；清理磁盘；重建副本。  
- 关键细节：过多小索引碎片化；watermark 阈值阻止分配。  
- 面试提示：说明“主分片丢失恢复路径”。

---

## 4. 面试问答速览（ES 相关）

（摘自原文 17.x）

1. 深分页替代方案？search_after/scroll/PIT 与稳定排序键。  
2. Doc Values 聚合为何快？列式存储避免加载源文档，内存友好。  
3. 主分片丢失如何恢复？定位故障 → 清理磁盘 → 分片重建与副本分配。  

---

## 5. 重要度汇总（Elasticsearch）

（摘自原文 19.x 的相关条目）

- 倒排索引/分词 / Doc Values / 深分页：[3/4]  
- 指标与故障 / 安全加固：[3]
