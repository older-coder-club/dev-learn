## 6. 日期与时间 API (java.time) [3]

### 6.1 核心类型语义
- 是什么：Instant（UTC 时间点）、LocalDateTime（无时区墙上时间）、ZonedDateTime（带时区规则与 DST）、OffsetDateTime（固定偏移，不含规则）、LocalDate（日期）、LocalTime（时间）、Duration（时间量，基于秒+纳）、Period（日期量，基于年月日）。  
- 为什么：分离“时间点”与“人类表示”，避免旧 Date/Calendar 线程不安全与语义混乱。  
- 怎么用：持久化/跨系统用 Instant（或 epoch milli/second）；展示转换到用户 ZoneId；纯业务周期（账期、生日）用 LocalDate；绝对比较用 Instant。  
- 关键细节：LocalDateTime 不唯一（DST 回拨重复小时）；OffsetDateTime 不自动处理夏令时；ZonedDateTime 包含 tz 数据库（可能更新）；Duration/Period 语义不同（Period 按日历）。  
- 常见陷阱：用 LocalDateTime 存数据库导致跨时区混淆；比较 OffsetDateTime 和 ZonedDateTime 混合；跨 DST 加 24h 与加 1 Day 结果不同。  
- 面试提示：强调“内部统一 Instant + 外部格式化”。  
- 案例：订单过期逻辑从 LocalDateTime 改 Instant 避免跨区提前失效。  
- 速记：Instant=绝对；LocalDateTime=墙钟；Zoned=规则；Offset=固定偏移。

### 6.2 不变性与线程安全
- 是什么：java.time 所有核心类不可变（immutable）。  
- 为什么：共享安全，无需同步；缓存/重用简化。  
- 怎么用：链式 plus/minus 返回新对象；可作为 Map key；DateTimeFormatter 线程安全单例。  
- 关键细节：大量链式创建仍有分配成本；频繁格式化大批量需复用 Formatter；避免在紧循环无必要构造。  
- 常见陷阱：误认为不可变零成本滥用创建；仍用 SimpleDateFormat 并加 synchronized。  
- 面试提示：对比旧 API 线程安全问题。  
- 案例：替换共享 SimpleDateFormat → DateTimeFormatter 后锁等待消失。  
- 速记：不可变=安全+简化；仍注意分配次数。

### 6.3 格式与解析
- 是什么：DateTimeFormatter 提供模式化格式/解析，支持 Locale 与 Zone。  
- 为什么：消除 SimpleDateFormat 线程安全问题；提升国际化准确性。  
- 怎么用：预定义常量：private static final DateTimeFormatter ISO = DateTimeFormatter.ISO_OFFSET_DATE_TIME; 定制 Pattern + Locale + Zone。  
- 关键细节：“yyyy” vs “YYYY”（周年 vs 历年）；Locale 影响月份/星期名称；解析失败抛 DateTimeParseException；格式化需指定 zone 才有偏移。  
- 常见陷阱：使用 YYYY 导致年底周跨年显示错误；忽略 Locale 导致土耳其 I 问题；混用 epoch 秒与毫秒。  
- 面试提示：举 YYYY vs yyyy 差异。  
- 案例：年报日期格式错误通过更换 yyyy 修复。  
- 速记：yyyy 非 YYYY；Formatter 复用；注意 Locale。

### 6.4 时区转换策略
- 是什么：统一以 UTC 存储与比较，展示时按用户 ZoneId。  
- 为什么：避免 DST 与偏移变化导致排序/过期错误。  
- 怎么用：Instant.now() 保存；展示：ZonedDateTime.ofInstant(instant, userZone)。  
- 关键细节：ZoneId 数据库需定期升级；DST 跳跃（春季跳过 1h，秋季重复 1h）；永远不要用 LocalDateTime 直接当绝对时间。  
- 常见陷阱：定时跑在 02:30（DST 跳过时刻）未执行；重复时段任务执行两次。  
- 面试提示：说明“UTC 存储 + Zone 显示”标准模式。  
- 案例：将任务基准改为 Instant + Cron Zone 解决重复触发。  
- 速记：存 UTC；显 Zone；DST 需警惕。

### 6.5 Clock 抽象
- 是什么：可注入的时间源（Clock.systemUTC(), Clock.fixed(..), Clock.offset(..)）。  
- 为什么：测试与模拟时间推进；隔离系统时钟。  
- 怎么用：服务类构造传入 Clock；测试用 fixed 或 offset 控制过期逻辑。  
- 关键细节：System.currentTimeMillis 不可控；nanoTime 仅用于测间隔不可转绝对时间；fixed Clock 需避免测试串影响。  
- 常见陷阱：测试直接 Thread.sleep 导致慢且不稳定；多处时间调用难 Mock。  
- 面试提示：展示注入 Clock 的方法签名。  
- 案例：过期测试由 sleep 2s 改 fixed Clock 减少测试耗时。  
- 速记：Clock 注入可测试；nanoTime 只测间隔。

### 6.6 Duration vs Period
- 是什么：Duration 表示基于时间量（秒+纳秒）；Period 表示基于日期量（年/月/日）。  
- 为什么：日期加法受日历规则（闰年、月长）影响；时间量精确到秒。  
- 怎么用：定时任务间隔用 Duration.ofMinutes(5)；账单周期用 Period.ofMonths(1)。  
- 关键细节：加 1 Period 月有 28/29/30/31 差异；Duration 跨 DST 加法结果时间点可能变化。  
- 常见陷阱：用 Duration 表示“一个月”导致天数不对；账期用天加法破坏月边界。  
- 面试提示：问“Period vs Duration 差异”给出日历 vs 时间量。  
- 案例：计费周期改 Period 正确处理闰年。  
- 速记：周期=Period；间隔=Duration。

### 6.7 TemporalAdjuster 与日期规则
- 是什么：提供定制日期调整（下一个工作日、月末等）。  
- 为什么：简化规则封装，避免重复手写逻辑。  
- 怎么用：date.with(TemporalAdjusters.lastDayOfMonth()); 自定义 Adjuster 实现 TemporalAdjuster。  
- 关键细节：Adjuster 返回新对象；链式组合；注意节假日附加逻辑需额外表。  
- 常见陷阱：多处手写月末逻辑出现 bug；未考虑跨年。  
- 面试提示：说明可扩展实现业务日历。  
- 案例：统一工作日计算减少重复代码。  
- 速记：Adjuster=标准日期规则工具。

### 6.8 DST 与调度陷阱
- 是什么：夏令时跳变：春季缺失小时，秋季重复小时。  
- 为什么：定时与差值计算可能错误。  
- 怎么用：基于 Instant + Cron Zone；每日执行在本地特定时间需检测跳变与补偿。  
- 关键细节：LocalDateTime 2:30 可能不存在；重复小时需标识“第一个还是第二个”。  
- 常见陷阱：任务在缺失时间不执行无人察觉；重复小时执行两次造成重复处理。  
- 面试提示：描述“秋季回拨补偿策略”（标记任务 ID）。  
- 案例：调度框架增加 DST 校验避免重复扣费。  
- 速记：DST 跳缺/回拨；调度用 Instant。

### 6.9 闰年与日期边界
- 是什么：闰年 2 月 29 日；Period/加法需处理。  
- 为什么：账期/订阅延展可能跨闰年。  
- 怎么用：LocalDate.plusYears(1) 自动处理；自定义按月循环 Period.ofMonths(1)。  
- 关键细节：Feb 29 + 1 year → Feb 28（非闰年）；手写算法易错。  
- 常见陷阱：解析“2024-02-29”后加一年期望 29 日失败。  
- 面试提示：说明库内部已处理不需手写。  
- 案例：订阅延长逻辑使用库函数修复日期异常。  
- 速记：闰年交给库；勿手写逻辑。

### 6.10 时间戳与精度
- 是什么：Instant 精度纳秒（实际实现到微/毫）；系统时钟分辨率平台不同。  
- 为什么：高频事件排序需足够精度。  
- 怎么用：Instant.now()；事件 ID 拼接 epochMilli+序列；或使用 nanoTime 差值。  
- 关键细节：currentTimeMillis 单调性不保证（系统调整）；nanoTime 单调但非绝对。  
- 常见陷阱：用 currentTimeMillis 计算间隔误差；时间回拨造成负间隔。  
- 面试提示：区分绝对 vs 单调。  
- 案例：延迟度量改 nanoTime 减异常值。  
- 速记：绝对=Instant；间隔=nanoTime。

### 6.11 解析与验证
- 是什么：输入字符串 → 时间对象验证格式与范围。  
- 为什么：防止非法日期（2023-13-40）或越界偏移。  
- 怎么用：捕获 DateTimeParseException，返回业务错误码；自定义解析逻辑限制范围。  
- 关键细节：宽松解析可能接受异常值；需要明确模式与 Locale。  
- 常见陷阱：未捕异常直接崩溃；允许外部偏移 +25:00。  
- 面试提示：强调“严格模式 + 异常转业务错误”。  
- 案例：输入校验减少 40% 解析崩溃。  
- 速记：严格解析；范围校验。

### 6.12 序列化与传输
- 是什么：时间对象在 JSON/ProtoBuf 中的表示。  
- 为什么：确保跨语言一致性与无歧义。  
- 怎么用：ISO-8601（UTC 用 Z）；或 epoch second/milli + zone 字段。  
- 关键细节：格式化指定 Zone；避免本地字符串无偏移；反序列化需校验长度与范围。  
- 常见陷阱：混用毫秒/秒；省略时区导致偏差。  
- 面试提示：推荐“Instant + ISO”或“epoch + zone”。  
- 案例：统一格式避免异构系统偏移错误。  
- 速记：ISO+Z；或 epoch+zone。

### 6.13 性能与对象创建
- 是什么：频繁创建时间对象/格式化影响性能。  
- 为什么：高频日志/序列化路径会成为热点。  
- 怎么用：缓存格式器；批处理减少转换；避免在循环内重复 Instant.now()（一次获取传递）。  
- 关键细节：时钟调用是系统调用边界；大量格式化增加 GC。  
- 常见陷阱：每条日志新建多个 Formatter；多次 Instant.now() 导致时间不一致。  
- 面试提示：说明减少多次 now() 获取。  
- 案例：Formatter 缓存后 GC 降 15%。  
- 速记：复用 Formatter；一次 now。

### 6.14 测试策略
- 是什么：验证时间逻辑的自动测试方法。  
- 为什么：边界日期易产生隐藏 bug。  
- 怎么用：使用 Clock.fixed；测试集合包含 DST 边界、闰年、月末；基准时用 epoch milli。  
- 关键细节：同时测试加 Period 与加 Duration；模拟回拨场景。  
- 常见陷阱：只测常规日期；未覆盖 DST。  
- 面试提示：列举测试用例清单。  
- 案例：增加 DST 测试捕获双执行。  
- 速记：Clock + 边界日期集。

### 6.15 常见陷阱汇总表
| 场景 | 问题 | 后果 | 规避 |
|------|------|------|------|
| LocalDateTime 存库 | 时区不明 | 比较错乱 | 用 Instant |
| 使用 YYYY | 周年偏差 | 年报日期错误 | 用 yyyy |
| DST 回拨调度 | 双执行 | 重复任务 | 用 UTC 基准 + 标记 |
| currentTimeMillis 度量 | 回拨异常 | 负值 | 用 nanoTime |
| 未升级 tz 数据库 | 时区偏移旧 | 时间错 | 定期更新 |
| 无白名单偏移 | 乱偏移 | 风险 | 校验范围 |
| 间隔用 Period(月) | 期望秒级 | 不符合 | 用 Duration |
| 直接序列化 LocalDateTime | 信息不足 | 客户端解析错 | 用 ISO Instant |

### 6.16 面试速答
| 问题 | 速答 |
| ---- | ---- |
| Instant vs LocalDateTime | 前者绝对 UTC，后者无时区易歧义 |
| ZonedDateTime 与 OffsetDateTime | Zoned 有规则+DST；Offset 仅偏移 |
| 为什么用 UTC 存储 | 避免 DST/偏移变化影响排序 |
| Duration vs Period | 时间量 vs 日历量 |
| YYYY 与 yyyy 差异 | 周年 vs 历年；用 yyyy |
| 如何测试过期逻辑 | 注入 Clock.fixed 控制时间 |
| DST 如何避免重复执行 | 以 Instant 调度 + 标记执行 |
| 计时间隔用什么 | nanoTime 单调度量 |
| 为什么不要 LocalDateTime 存绝对时间 | 无时区无法跨地区还原 |

### 6.17 答题模板示例（“跨时区与 DST 调度设计”）
1. 是什么：定时任务在不同区域并跨夏令时。  
2. 为什么：防止重复或遗漏执行。  
3. 怎么用：内部用 Instant 标记执行点；转换目标 Zone 生成人类显示；检测 DST 跳变补偿策略。  
4. 关键细节：重复小时标记；缺失小时延迟至下一有效时间；日志统一 UTC。  
5. 陷阱：直接用 LocalDateTime 循环加 24h。  
6. 案例：迁移后避免秋季重复扣费。  
7. 速记：Instant+Zone 展示；DST 校验。

### 6.18 最佳实践速记清单
- 存储与比较用 Instant/epoch。  
- 展示转换用户时区（ZoneId）。  
- 选择 Duration（时间间隔） vs Period（账期）。  
- Formatter 复用并正确使用 yyyy。  
- 使用 Clock 注入测试稳定。  
- 调度基于 Instant，处理 DST 边界。  
- 严格解析 + Locale 明确。  
- 序列化用 ISO8601（含偏移）或 epoch+zone。  
- 避免 LocalDateTime 表示绝对时间